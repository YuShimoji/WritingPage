# 実装計画書

**作成日**: 2025-01-19  
**プロジェクト**: Zen Writer (WritingPage)  
**バージョン**: 0.3.18  
**計画期間**: 2025-01-19 ～ 2025-04-19（3ヶ月）

---

## 1. 実装計画の概要

本計画書は、`docs/PROJECT_ANALYSIS_REPORT.md` で特定された未実装機能と進行中タスクを、優先順位と依存関係に基づいて実装するための詳細計画です。

### 1.1 計画の目的

- 未実装機能の段階的な実装
- 技術的負債の返済
- コード品質の向上
- ドキュメント整合性の確保

### 1.2 計画の範囲

- **Phase 1**: セキュリティ・整合性の確保（P0/P1）
- **Phase 2**: UI安定化と基盤整備
- **Phase 3**: 機能拡張
- **Phase 4**: コード品質改善

---

## 2. Phase 1: セキュリティ・整合性の確保（最優先）

### 2.1 P0-1: Embed SDK の same-origin 判定と origin 検証の正規化

**優先度**: P0（緊急）  
**見積もり**: 2-3日  
**依存関係**: なし  
**担当**: 開発者

#### 実装手順

1. **現状調査**
   - [ ] `js/embed/zen-writer-embed.js` の `sameOrigin` 処理を確認
   - [ ] `js/embed/child-bridge.js` の `postMessage` 受信処理を確認
   - [ ] `docs/EMBED_SDK.md` の仕様を確認

2. **設計決定**
   - [ ] `src` の origin から `sameOrigin` を自動判定するロジックを設計
   - [ ] `postMessage` 受信時の origin チェックを強化
   - [ ] エラーメッセージの改善

3. **実装**
   - [ ] `sameOrigin` の自動判定を実装
   - [ ] `postMessage` の origin 検証を強化
   - [ ] エラーメッセージを改善

4. **テスト**
   - [ ] 同一originでの動作確認
   - [ ] クロスオリジンでの動作確認
   - [ ] `npm run test:smoke` の実行
   - [ ] E2Eテストの追加（必要に応じて）

5. **ドキュメント更新**
   - [ ] `docs/EMBED_SDK.md` の更新
   - [ ] `CHANGELOG.md` の更新

#### 受け入れ条件

- [ ] cross-origin（異なる origin）で `sameOrigin` 未指定でも `targetOrigin` が `src` から推定され、`ZW_EMBED_READY` を受信できる
- [ ] postMessage の受信は `targetOrigin` と一致しない場合に破棄される
- [ ] 同一originで API が見つからない場合、誤った cross-origin エラーメッセージを出さない

### 2.2 P1-3: `docs/KNOWN_ISSUES.md` のバージョン表記と実態の整合

**優先度**: P1（高）  
**見積もり**: 0.5日  
**依存関係**: なし  
**担当**: 開発者

#### 実装手順

1. **現状確認**
   - [ ] `docs/KNOWN_ISSUES.md` のバージョン表記を確認
   - [ ] `package.json` のバージョンを確認
   - [ ] `VERSION` ファイルのバージョンを確認

2. **整合性確認**
   - [ ] 各バージョン表記が現行バージョン（0.3.18）と一致しているか確認
   - [ ] 「改善済み」の表記が正しいか確認

3. **更新**
   - [ ] 不一致があれば修正
   - [ ] 改善済み項目の表記を更新

4. **検証**
   - [ ] `npm run lint` の実行

### 2.3 P1-1/P1-2/P1-4/P1-5: ドキュメントの SSOT 化

**優先度**: P1（高）  
**見積もり**: 2-3日  
**依存関係**: P1-3完了後  
**担当**: 開発者

#### 実装手順

1. **P1-1: 設定ハブ（DESIGN_HUB）の扱い決定**
   - [ ] `docs/DESIGN_HUB.md` の内容を確認
   - [ ] OpenSpec change に昇格するか、`docs/BACKLOG.md` に統合するか決定
   - [ ] 決定に基づいてドキュメントを更新

2. **P1-2: Wiki の「制限事項」表記の SSOT 化**
   - [ ] `docs/GADGETS.md` の Wiki 節を確認
   - [ ] 実装済み/未実装を `docs/DEVELOPMENT_STATUS.md` または OpenSpec へ集約
   - [ ] `docs/GADGETS.md` を参照に変更

3. **P1-4: `docs/GADGETS.md` の「現行実装」と「将来案/旧メモ」の混在を解消**
   - [ ] 節単位でステータスを明確化（`（現行）` / `（提案・未実装）`）
   - [ ] 将来案が OpenSpec に存在する場合は該当 change/spec へ寄せ、`docs/GADGETS.md` 側は参照に留める

4. **P1-5: smoke/dev-check の期待値と現行実装の整合**
   - [ ] `scripts/dev-check.js` のコメントを現行実装に合わせて更新
   - [ ] UI が存在する場合は UI の存在/動線を検証するように更新

5. **検証**
   - [ ] `npm run test:smoke` の実行
   - [ ] `npm run lint` の実行

---

## 3. Phase 2: UI安定化と基盤整備

### 3.1 `ui-stability-and-cleanup` の実装

**優先度**: P2（中）  
**見積もり**: 5-7日  
**依存関係**: Phase 1完了後  
**担当**: 開発者

#### 実装手順

1. **サイドバータブ切り替えの実装**
   - [ ] 動的に生成されたタブボタンにクリックハンドラーを追加
   - [ ] アクティブタブの状態更新を確認
   - [ ] タブパネルの表示/非表示を確認

2. **ロードアウト管理のガジェット化**
   - [ ] LoadoutManager ガジェットを作成
   - [ ] ハードコードされたロードアウトUIをガジェットに置き換え
   - [ ] 保存/読み込み機能を確認

3. **Wiki ヘルプ機能の実装**
   - [ ] Wiki タブにヘルプボタンを追加
   - [ ] ヘルプコンテンツ表示を作成
   - [ ] ヘルプの開閉を確認

4. **トップメニューのクリーンアップ**
   - [ ] 不要なカレンダー要素を削除
   - [ ] 執筆目標をガジェットの有効/無効で制御可能にする
   - [ ] 目標UIの突然の色変更と絵文字を削除

5. **執筆目標UIの改善**
   - [ ] 入力時の青いバーを削除
   - [ ] ユーザーが色と絵文字を制御できるようにする
   - [ ] UI変更のスムーズなトランジションを追加

6. **文字数表示動作のドキュメント化**
   - [ ] スペースベースのカウントを説明するコメントを追加
   - [ ] 将来の変更のためのモックアップ動作として参照

7. **検証**
   - [ ] `npm run test:smoke` の実行
   - [ ] `npm run lint` の実行
   - [ ] `npm run test:e2e:ci` の実行

### 3.2 `polish-ui-from-test-feedback` の実装（優先項目のみ）

**優先度**: P2（中）  
**見積もり**: 3-5日  
**依存関係**: Phase 2-1完了後  
**担当**: 開発者

#### 実装手順

1. **パネルレイアウト修正**
   - [ ] 左サイドバー展開時のメインエリア隠れを修正
   - [ ] レイアウト変更のテスト検証

2. **エディタスクロール挙動改善**
   - [ ] エディタキー移動時のガクガク振動を修正
   - [ ] スクロール安定性のテスト

3. **検証**
   - [ ] `npm run test:smoke` の実行
   - [ ] `npm run lint` の実行
   - [ ] `npm run test:e2e:ci` の実行

---

## 4. Phase 3: 機能拡張

### 4.1 Wiki機能の統合実装

**優先度**: P2（中）  
**見積もり**: 10-14日  
**依存関係**: Phase 2完了後  
**担当**: 開発者

#### 実装手順

1. **Wiki CRUD のSSOT確定**
   - [ ] ストレージAPI: create/update/delete/search を確定
   - [ ] データスキーマを設計

2. **Wiki ガジェットUI実装**
   - [ ] 一覧/編集/テンプレートUIを実装
   - [ ] 既存実装がある場合は差分整理

3. **ページ間リンクの要件化**
   - [ ] 保存形式/リンク解決ルールを確定
   - [ ] 実装（最小限）

4. **Wiki データの import/export**
   - [ ] localStorage前提で実装 or 仕様化

5. **E2Eテスト**
   - [ ] Wiki create/search/save + リロード永続のテスト

6. **ドキュメント更新**
   - [ ] `docs/GADGETS.md` の未実装表記を SSOT 参照へ整理

### 4.2 Node Graph機能の実装

**優先度**: P2（中）  
**見積もり**: 7-10日  
**依存関係**: Phase 3-1完了後  
**担当**: 開発者

#### 実装手順

1. **nodes/edges スキーマの設計**
   - [ ] データ構造を定義
   - [ ] ストレージスキーマを設計

2. **Node Graph UI実装**
   - [ ] ドラッグ移動機能
   - [ ] SVGエッジ+ラベルの描画
   - [ ] ドッキング可能パネルでの表示

3. **ストレージ実装**
   - [ ] ドキュメントごとのストレージ実装

4. **E2Eテスト**
   - [ ] Node Graph add node/link; persists after reload のテスト

---

## 5. Phase 4: コード品質改善

### 5.1 editor.js / app.js のリファクタリング

**優先度**: P2（中）  
**見積もり**: 7-10日  
**依存関係**: Phase 3完了後  
**担当**: 開発者

#### 実装手順

1. **現状分析**
   - [ ] `js/editor.js` (1763行) の責務を分析
   - [ ] `js/app.js` (1437行) の責務を分析
   - [ ] 分割可能な単位を特定

2. **分割計画**
   - [ ] 各ファイルを500行以下に分割する計画を立てる
   - [ ] 新しいファイル構造を設計

3. **段階的なリファクタリング**
   - [ ] 小さな単位で分割
   - [ ] 各ステップでテスト実行
   - [ ] ドキュメント更新

4. **検証**
   - [ ] `npm run test:smoke` の実行
   - [ ] `npm run lint` の実行
   - [ ] `npm run test:e2e:ci` の実行

### 5.2 ツールレジストリとプラグインシステムの整理

**優先度**: P2（中）  
**見積もり**: 3-5日  
**依存関係**: Phase 4-1完了後  
**担当**: 開発者

#### 実装手順

1. **設計決定**
   - [ ] ツールレジストリとUI入口の接続方針を決定
   - [ ] プラグインシステムの「UI有無」を明確化

2. **実装**
   - [ ] 決定した方針に基づいて実装
   - [ ] ドキュメント更新

3. **検証**
   - [ ] `npm run test:smoke` の実行
   - [ ] `npm run lint` の実行

---

## 6. 進捗管理と品質保証

### 6.1 進捗確認のタイミング

- **日次**: タスクの完了確認
- **週次**: フェーズの進捗確認
- **月次**: 計画全体の見直し

### 6.2 品質保証チェックリスト

各タスク完了時に以下を確認:

- [ ] すべてのテストが通過（`npm test`）
- [ ] Lintエラーがない（`npm run lint`）
- [ ] ドキュメントが更新されている
- [ ] `CHANGELOG.md` が更新されている
- [ ] `AI_CONTEXT.md` が更新されている（該当する場合）
- [ ] OpenSpec が更新されている（該当する場合）

### 6.3 リスク管理

#### リスク1: 実装時間の超過

- **対策**: 見積もりに20%のバッファを追加
- **対応**: 優先度の低いタスクを延期

#### リスク2: 依存関係の複雑化

- **対策**: 依存関係を明確に文書化
- **対応**: 必要に応じて計画を調整

#### リスク3: テストの不足

- **対策**: 各フェーズでテストを追加
- **対応**: 回帰テストを強化

---

## 7. まとめ

本実装計画は、プロジェクトの徹底分析に基づいて策定されました。優先順位と依存関係を考慮し、段階的に実装を進めることで、効率的かつ確実に未実装機能を完成させ、技術的負債を返済します。

### 次のステップ

1. Phase 1のタスクに着手
2. 週次レビューで進捗確認
3. 必要に応じて計画を調整

---

**更新履歴**:

- 2025-01-19: 初版作成
