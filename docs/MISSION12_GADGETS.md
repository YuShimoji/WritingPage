# Mission 12 — ガジェット機能詳細設計

最終更新: 2025-10-15T17:20:00+09:00
更新者: Cascade AI

## 目的
- サイドバー利便性機能をガジェットとして統一し、ユーザーが順序・表示状態を自由に管理できるようにする。
- ガジェット固有設定を共通フレームワークで扱い、UI/UX を整理する。
- 仕様を明文化し、別端末や後続ミッションでも開発を継続できるようにする。

## 要件整理
- ガジェット一覧は D&D で並び替え可能。操作感向上のためハイライト/プレースホルダーを導入する。
- 並び替えの結果は `localStorage` (`zenWriter_gadgets:prefs.order`) に永続化し、欠損値にも強い実装を維持する。
- ガジェット単位で表示/非表示を切り替えられる UI を追加。非表示状態でも prefs に状態を保持。
- ガジェットの設定パネルは共通 API (`registerSettings`) を介して描画し、二重レンダリングを防止する。
- 従来のサイドバー「執筆目標」セクションをガジェット化し、他のガジェット同様に並び替え・表示制御できるようにする。

## 実装タスクリスト
1. D&D UX 改善
   - `dragstart/dragover/drop` イベントでスタイルクラスを操作し、挿入位置を可視化。
   - 同一アイテムを繰り返し移動した場合でも順序が安定するよう `eff` 配列の更新処理を調整。
   - ドロップ後にフォーカス/スクロールを適切に処理。
2. 表示制御フレームワーク
   - ガジェットヘッダへ「表示切替」トグルを追加。
   - prefs に `visibility[name]` を追加し、`render()` 時に反映。
3. ガジェット設定フレームワーク強化
   - 設定パネルの開閉状態を prefs に保存。
   - 設定 UI を描画する際に既存 DOM を再利用し、レンダリングコストを削減。
4. 執筆目標ガジェット化
   - 既存 `#goal-target` 等の入力要素をガジェットとして再構成。
   - 設定値は既存ストレージ (`zenWriter_goal` 系) を再利用するか、必要に応じて移行処理を追加。
5. E2E テスト追加
   - 並び替えが `localStorage` に反映されることを検証。
   - 執筆目標ガジェットの表示/非表示切替と設定保持をテスト。

## テスト計画
- `npm run test:e2e`
- `npm run test:smoke`
- ブラウザ手動確認（ドラッグ操作、設定パネル開閉、執筆目標ガジェットの設定保存）

## フォローアップ
- アコーディオンメニュー（アウトライン、テーマ等）にも同様の並び替え/表示制御を適用する設計を検討。
- Mission 13 移行時に、画像挿入ボタンを含むフロートツールバーへガジェット設定連携を行う。
