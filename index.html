<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zen Writer - 小説執筆ツール</title>
    <script>
      (function(){
        // 埋め込みモード判定（?embed=1）
        var isEmbed = /(?:^|[?&])embed=1(?:&|$)/.test(location.search);
        if (isEmbed) {
          document.documentElement.setAttribute('data-embed','true');
        }
        try {
          var raw = localStorage.getItem('zenWriter_settings');
          if (raw) {
            var s = JSON.parse(raw);
            if (s && s.toolbarVisible === false) {
              document.documentElement.setAttribute('data-toolbar-hidden','true');
            }
          } else {
            // 設定が未作成（初回起動）は非表示にする
            document.documentElement.setAttribute('data-toolbar-hidden','true');
          }
        } catch(e) { /* ignore */ }
        // 埋め込みモードではツールバーを強制的に隠す（最小UI）
        if (isEmbed) {
          document.documentElement.setAttribute('data-toolbar-hidden','true');
        }
      })();
    </script>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="stylesheet" href="css/style.css">
    <script>
      // 非埋め込み時のみ Google Fonts を動的に読み込む（preconnect 最適化込み）
      (function(){
        try {
          var isEmbed = /(?:^|[?&])embed=1(?:&|$)/.test(location.search);
          if (isEmbed) return;
          var head = document.getElementsByTagName('head')[0];
          var l1 = document.createElement('link'); l1.rel = 'preconnect'; l1.href = 'https://fonts.googleapis.com';
          var l2 = document.createElement('link'); l2.rel = 'preconnect'; l2.href = 'https://fonts.gstatic.com'; l2.crossOrigin = '';
          var css = document.createElement('link'); css.rel = 'stylesheet'; css.href = 'https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&display=swap';
          head.appendChild(l1); head.appendChild(l2); head.appendChild(css);
        } catch(_) {}
      })();
    </script>
</head>
<body>
    <div class="app-container">
        <!-- サイドバー -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>設定</h2>
                <button id="close-sidebar" class="icon-button">×</button>
            </div>

            
            
            <div class="sidebar-section">
                <details id="theme-section">
                    <summary>テーマ</summary>
                    <div class="theme-presets" style="margin-top:8px;">
                        <button class="theme-preset" data-theme="light">ライト</button>
                        <button class="theme-preset" data-theme="dark">ダーク</button>
                        <button class="theme-preset" data-theme="sepia">セピア</button>
                    </div>

                    <div class="sidebar-section">
                        <h3>テーマプリセット（拡張）</h3>
                        <label for="theme-bundle-select">プリセット</label>
                        <select id="theme-bundle-select"></select>
                        <div class="bundle-controls">
                            <input type="text" id="theme-bundle-name" placeholder="現在の設定を保存（名前）">
                            <button id="save-theme-bundle">保存</button>
                            <button id="apply-theme-bundle">適用</button>
                            <button id="delete-theme-bundle">削除</button>
                        </div>
                    </div>
                    
                    <div class="color-picker">
                        <label for="bg-color">背景色</label>
                        <input type="color" id="bg-color" value="#ffffff">
                        
                        <label for="text-color">文字色</label>
                        <input type="color" id="text-color" value="#333333">
                        <button id="reset-colors" class="button" style="margin-top:0.5rem;">カスタム色リセット</button>
                    </div>
                </details>
            </div>
            
            <div class="sidebar-section">
                <h3>フォント</h3>
                <select id="font-family">
                    <option value="'Noto Serif JP', serif">Noto Serif JP</option>
                    <option value="'Yu Mincho', 'YuMincho', serif">游明朝</option>
                    <option value="'Hiragino Mincho ProN', serif">ヒラギノ明朝</option>
                </select>
                
                <label for="font-size">フォントサイズ: <span id="font-size-value">16</span>px</label>
                <input type="range" id="font-size" min="12" max="32" value="16">
                
                <label for="line-height">行間: <span id="line-height-value">1.6</span></label>
                <input type="range" id="line-height" min="1" max="3" step="0.1" value="1.6">
            </div>
            
            <div class="sidebar-section">
                <h3>HUD 設定</h3>
                <label for="hud-position">表示位置</label>
                <select id="hud-position">
                    <option value="bottom-left">左下</option>
                    <option value="bottom-right">右下</option>
                    <option value="top-left">左上</option>
                    <option value="top-right">右上</option>
                </select>

                <label for="hud-duration">表示時間（ms）</label>
                <input type="number" id="hud-duration" min="300" max="5000" step="100" value="1200">

                <label for="hud-bg">背景色</label>
                <input type="color" id="hud-bg" value="#000000">

                <label for="hud-fg">文字色</label>
                <input type="color" id="hud-fg" value="#ffffff">

                <label for="hud-opacity">不透明度: <span id="hud-opacity-value">0.75</span></label>
                <input type="range" id="hud-opacity" min="0" max="1" step="0.05" value="0.75">
                <button id="hud-test" class="small" style="margin-top:6px;">HUDテスト表示</button>
            </div>
            
            <div class="sidebar-section">
                <h3>執筆目標</h3>
                <label for="goal-target">目標文字数</label>
                <input type="number" id="goal-target" min="0" step="100" value="0">
                <label for="goal-deadline">締切（任意）</label>
                <input type="date" id="goal-deadline">
            </div>
            
            <div class="sidebar-section">
                <h3>アウトライン</h3>
                <label for="outline-set">プリセット</label>
                <select id="outline-set"></select>
                <div class="outline-controls">
                    <details>
                        <summary>新しいプリセットを作成</summary>
                        <label for="outline-new-name">名前</label>
                        <input type="text" id="outline-new-name" placeholder="例: 三部構成">
                        <label for="outline-new-levels">レベル（カンマ区切り）</label>
                        <input type="text" id="outline-new-levels" placeholder="部,章,節">
                        <button id="create-outline-set">作成</button>
                    </details>
                </div>
                <div id="outline-levels-container" class="outline-levels"></div>
                <div id="outline-insert-buttons" class="outline-insert"></div>
            </div>

            <div class="sidebar-section">
                <h3>拡張機能</h3>
                <div id="plugins-panel" class="plugins-panel" aria-label="プラグイン操作"></div>
            </div>

            <div class="sidebar-section">
                <h3>バックアップ</h3>
                <button id="snapshot-now">今すぐ保存</button>
                <div id="snapshot-list" class="snapshot-list" style="margin-top:8px;"></div>
            </div>

            <div class="sidebar-section">
                <h3>ドキュメント</h3>
                <label for="doc-select">ドキュメント一覧</label>
                <select id="doc-select"></select>
                <div class="doc-actions" style="display:flex; gap:6px; margin:6px 0;">
                    <button id="doc-create" class="small">作成</button>
                    <button id="doc-rename" class="small">改名</button>
                    <button id="doc-delete" class="small">削除</button>
                </div>
                <button id="new-document">新規ドキュメント</button>
                <button id="import-file">ファイルを読み込む</button>
                <input type="file" id="file-input" accept=".txt,.md,.markdown,.text" style="display:none" />
                <button id="export-txt">テキストで保存</button>
                <button id="export-md">Markdownで保存</button>
                <button id="print-document">印刷</button>
            </div>
        </aside>
        
        <!-- メインコンテンツ -->
        <main class="main-content">
            <!-- ツールバー -->
            <div class="toolbar">
                <button id="toggle-sidebar" class="icon-button" aria-label="サイドバーを開閉">☰</button>
                <div class="word-count">0 文字</div>
                <div id="goal-progress" class="goal-progress" aria-hidden="true" style="display:none;">
                    <div class="goal-progress__track">
                        <div class="goal-progress__bar" style="width:0%"></div>
                    </div>
                </div>
                <div class="toolbar-actions">
                    <button id="toggle-toolbar" class="icon-button" aria-label="ツールバーを開閉">⌨️</button>
                    <button id="fullscreen" class="icon-button" aria-label="フルスクリーン切替">⛶</button>
                </div>
            </div>
            
            <!-- エディタエリア -->
            <div class="editor-container">
                <textarea id="editor" placeholder="ここに小説を入力してください..."></textarea>
                <div id="print-view" class="print-view" aria-hidden="true"></div>
            </div>
        </main>
    </div>
    <!-- ツールバー再表示用FAB -->
    <button id="show-toolbar" class="fab-toggle-toolbar" title="ツールバーを表示" aria-label="ツールバーを表示" style="display:none;">⌨️</button>
    <!-- 追加機能用FAB -->
    <button id="fab-tools" class="fab-tools" title="ツール" aria-label="ツール">⚙️</button>
    <!-- フローティングフォントパネル -->
    <div id="floating-font-panel" class="floating-panel" style="display:none;">
        <div class="panel-header">
            <span>フォントサイズ</span>
            <button class="panel-close" id="close-font-panel">×</button>
        </div>
        <div class="panel-body">
            <input type="range" id="global-font-size" min="12" max="48" value="16">
            <div class="panel-row">
                <input type="number" id="global-font-size-number" min="12" max="48" value="16" style="width:72px;"> px
            </div>
            <div class="panel-hint">ショートカット: Ctrl/⌘ + (+ / - / 0)</div>
        </div>
    </div>
    
    <script src="js/storage.js"></script>
    <script src="js/theme.js"></script>
    <script src="js/hud.js"></script>
    <script src="js/editor.js"></script>
    <script src="js/app.js"></script>
    <!-- 埋め込み時のpostMessageブリッジ（?embed=1でREADY/RPC受信） -->
    <script src="js/embed/child-bridge.js"></script>
    <script>
      // 非埋め込み時のみ Outline/高度テーマ/プラグインを動的ロード（埋め込みでの初期ロードを軽量化）
      (function(){
        var isEmbed = /(?:^|[?&])embed=1(?:&|$)/.test(location.search);
        if (isEmbed) return;
        function load(src){ var s=document.createElement('script'); s.src=src; s.defer=true; document.body.appendChild(s); }
        load('js/outline.js');
        load('js/themes-advanced.js');
        load('js/plugins/registry.js');
        load('js/plugins/choice.js');
      })();
    </script>
</body>
</html>
