<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Zen Writer - 小説執筆ツール</title>
    <script>
      (function () {
        // 埋め込みモード判定（?embed=1）
        var isEmbed = /(?:^|[?&])embed=1(?:&|$)/.test(location.search);
        if (isEmbed) {
          document.documentElement.setAttribute('data-embed', 'true');
        }
        try {
          var raw = localStorage.getItem('zenWriter_settings');
          if (raw) {
            var s = JSON.parse(raw);
            if (s && s.toolbarVisible === false) {
              document.documentElement.setAttribute(
                'data-toolbar-hidden',
                'true',
              );
            }
          } else {
            // 設定が未作成（初回起動）は非表示にする
            document.documentElement.setAttribute(
              'data-toolbar-hidden',
              'true',
            );
          }
        } catch (e) {
          /* ignore */
        }
        // 埋め込みモードではツールバーを強制的に隠す（最小UI）
        if (isEmbed) {
          document.documentElement.setAttribute('data-toolbar-hidden', 'true');
        }
      })();
    </script>
    <link rel="icon" type="image/svg+xml" href="favicon.svg" />
    <link rel="stylesheet" href="css/style.css" />
    <script>
      // 非埋め込み時のみ Google Fonts を動的に読み込む（preconnect 最適化込み）
      (function () {
        try {
          var isEmbed = /(?:^|[?&])embed=1(?:&|$)/.test(location.search);
          if (isEmbed) return;
          var head = document.getElementsByTagName('head')[0];
          var l1 = document.createElement('link');
          l1.rel = 'preconnect';
          l1.href = 'https://fonts.googleapis.com';
          var l2 = document.createElement('link');
          l2.rel = 'preconnect';
          l2.href = 'https://fonts.gstatic.com';
          l2.crossOrigin = '';
          var css = document.createElement('link');
          css.rel = 'stylesheet';
          css.href =
            'https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&display=swap';
          head.appendChild(l1);
          head.appendChild(l2);
          head.appendChild(css);
        } catch (_) {}
      })();
    </script>
  </head>
  <body>
    <div class="app-container">
      <!-- サイドバー -->
      <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <h2>ガジェット設定</h2>
          <!-- ヘッダーの閉じるボタンを削除：ツールバー側に統一 -->
        </div>

        <div class="sidebar-top">
          <!-- タブ切り替えUI -->
          <div class="sidebar-tabs" role="tablist" aria-label="設定カテゴリ"></div>
          <div class="sidebar-loadout">
            <label for="loadout-select">ロードアウト</label>
            <div class="loadout-controls">
              <select
                id="loadout-select"
                aria-label="ロードアウトを選択"
              ></select>
              <input
                type="text"
                id="loadout-name"
                placeholder="プリセット名"
                aria-label="ロードアウト名"
              />
              <div class="loadout-buttons">
                <button id="loadout-save" class="small" type="button">
                  保存
                </button>
                <button id="loadout-duplicate" class="small" type="button">
                  複製
                </button>
                <button id="loadout-apply" class="small" type="button">
                  適用
                </button>
                <button id="loadout-delete" class="small" type="button">
                  削除
                </button>
              </div>
            </div>
          </div>
        </div>

        <div class="sidebar-groups">
          <section
            class="sidebar-group active"
            data-group="structure"
            id="sidebar-group-structure"
            role="tabpanel"
            aria-labelledby="sidebar-tab-structure"
          >
            <div class="sidebar-section">
              <div
                id="structure-gadgets-panel"
                class="gadgets-panel"
                data-gadget-group="structure"
                aria-label="構造ガジェット"
              ></div>
            </div>
          </section>

          <section
            class="sidebar-group"
            data-group="typography"
            id="sidebar-group-typography"
            role="tabpanel"
            aria-labelledby="sidebar-tab-typography"
            aria-hidden="true"
            style="display: none;"
          >
            <div class="sidebar-section">
              <div
                id="typography-gadgets-panel"
                class="gadgets-panel"
                data-gadget-group="typography"
                aria-label="タイポグラフィガジェット"
              ></div>
            </div>
          </section>

          <section
            class="sidebar-group"
            data-group="assist"
            id="sidebar-group-assist"
            role="tabpanel"
            aria-labelledby="sidebar-tab-assist"
            aria-hidden="true"
            style="display: none;"
          >
            <div class="sidebar-section">
              <div
                id="plugins-panel"
                class="plugins-panel"
                aria-label="プラグイン操作"
              ></div>
            </div>

            <div class="sidebar-section">
              <div
                id="gadgets-panel"
                class="gadgets-panel"
                aria-label="ガジェット"
              ></div>
              <div
                class="gadget-tools"
                style="
                  margin-top: 8px;
                  display: flex;
                  flex-wrap: wrap;
                  gap: 6px;
                "
              >
                <button id="gadget-export" class="small" type="button">
                  ガジェット設定をエクスポート
                </button>
                <button id="gadget-import" class="small" type="button">
                  ガジェット設定をインポート
                </button>
                <input
                  id="gadget-prefs-input"
                  type="file"
                  accept="application/json,.json"
                  style="display: none"
                />
              </div>
            </div>
          <section
            class="sidebar-group"
            data-group="wiki"
            id="sidebar-group-wiki"
            role="tabpanel"
            aria-labelledby="sidebar-tab-wiki"
            aria-hidden="true"
            style="display: none;"
          >
            <div class="sidebar-section">
              <div
                id="wiki-gadgets-panel"
                class="gadgets-panel"
                data-gadget-group="wiki"
                aria-label="Wikiガジェット"
              ></div>
            </div>
          </section>
            <div class="sidebar-section">
              <h4>タイプライターモード</h4>
              <div class="panel-row">
                <label for="typewriter-enabled">有効化</label>
                <input type="checkbox" id="typewriter-enabled" />
              </div>
              <div class="panel-row">
                <label for="typewriter-anchor-ratio">アンカー位置 (0.05-0.95)</label>
                <input type="range" id="typewriter-anchor-ratio" min="0.05" max="0.95" step="0.05" value="0.5" />
              </div>
              <div class="panel-row">
                <label for="typewriter-stickiness">張り付き強度 (0-1)</label>
                <input type="range" id="typewriter-stickiness" min="0" max="1" step="0.1" value="0.9" />
              </div>
            </div>
            <div class="sidebar-section">
              <h4>自動保存</h4>
              <div class="panel-row">
                <label for="auto-save-enabled">リアルタイム自動保存</label>
                <input type="checkbox" id="auto-save-enabled" />
              </div>
              <div class="panel-row">
                <label for="auto-save-delay-ms">遅延時間 (ms)</label>
                <input type="number" id="auto-save-delay-ms" min="500" max="10000" step="500" value="2000" />
              </div>
            </div>
            <div class="sidebar-section">
              <h4>オートセーブ & スナップショット</h4>
              <div class="panel-row">
                <label for="snapshot-interval-ms">間隔 (ms, 30000-300000)</label>
                <input type="number" id="snapshot-interval-ms" min="30000" max="300000" step="30000" value="120000" />
              </div>
              <div class="panel-row">
                <label for="snapshot-delta-chars">差分文字数 (50-1000)</label>
                <input type="number" id="snapshot-delta-chars" min="50" max="1000" step="50" value="300" />
              </div>
              <div class="panel-row">
                <label for="snapshot-retention">保持数 (1-50)</label>
                <input type="number" id="snapshot-retention" min="1" max="50" step="1" value="10" />
              </div>
            </div>
            <div class="sidebar-section">
              <h4>Markdownプレビュー</h4>
              <div class="panel-row">
                <label for="preview-sync-scroll">スクロール同期</label>
                <input type="checkbox" id="preview-sync-scroll" />
              </div>
            </div>
          </section>
        </div>
        <div class="sidebar-section">
          <h3>ヘルプ</h3>
          <button class="button" id="help-button">Wikiヘルプを開く</button>
        </div>
      </aside>

      <!-- メインコンテンツ -->
      <main class="main-content">
        <!-- ツールバー -->
        <div class="toolbar">
          <div class="sidebar-controls">
            <button
              id="toggle-sidebar"
              class="icon-button"
              aria-label="サイドバーを開閉"
            >
              メニュー
            </button>
            <button
              id="toolbar-close-sidebar"
              class="icon-button sidebar-close-btn"
              aria-label="サイドバーを閉じる"
              style="display: none"
            >
              閉じる
            </button>
          </div>
          <div class="word-count">0 文字</div>
          <div
            id="goal-progress"
            class="goal-progress"
            aria-hidden="true"
            style="display: none"
          >
            <div class="goal-progress__track">
              <div class="goal-progress__bar" style="width: 0%"></div>
            </div>
          </div>
          <input type="number" id="goal-target" placeholder="目標文字数" style="width: 100px; margin-right: 8px;" />
          <input type="date" id="goal-deadline" aria-label="締切日" style="margin-right: 8px;" />
          <div class="toolbar-actions">
            <button
              id="toggle-text-animation"
              class="icon-button"
              title="テキストアニメーション"
              aria-label="テキストアニメーションパネルを開く"
            >
              アニメ
            </button>
            <button
              id="toggle-font-decoration"
              class="icon-button"
              title="フォント装飾"
              aria-label="フォント装飾パネルを開く"
            >
              装飾
            </button>
            <button
              id="insert-stamp"
              class="icon-button"
              title="文字数スタンプ挿入"
              aria-label="文字数スタンプを挿入"
            >
              スタンプ
            </button>
            <button
              id="toggle-toolbar"
              class="icon-button"
              aria-label="ツールバーを開閉"
            >
              ツールバー
            </button>
            <button
              id="feedback"
              class="icon-button"
              aria-label="フィードバック"
            >
              フィードバック
            </button>
          </div>
        </div>

        <!-- エディタエリア -->
        <div class="editor-container">
          <div class="editor-canvas">
            <textarea
              id="editor"
              placeholder="ここに小説を入力してください..."
            ></textarea>
            <div
              id="editor-overlay"
              class="editor-overlay"
              aria-hidden="true"
            ></div>
            <div
              id="editor-mirror"
              class="editor-mirror"
              aria-hidden="true"
            ></div>
          </div>
          <div
            id="editor-preview"
            class="editor-preview editor-preview--collapsed"
            aria-live="polite"
          >
            <div id="editor-preview-body" class="editor-preview__body"></div>
          </div>
          <div id="print-view" class="print-view" aria-hidden="true"></div>
        </div>
      </main>
    </div>
    <!-- ツールバー再表示用FAB -->
    <button
      id="show-toolbar"
      class="fab-toggle-toolbar"
      title="ツールバーを表示"
      aria-label="ツールバーを表示"
      style="display: none"
    >
      ツールバー
    </button>
    <!-- 追加機能用FAB -->
    <button id="fab-tools" class="fab-tools" title="ツール" aria-label="ツール">
      ツール
    </button>
    <!-- フローティングフォントパネル -->
    <div id="floating-font-panel" class="floating-panel" style="display: none">
      <div class="panel-header">
        <span>フォントサイズ</span>
        <button class="panel-close" id="close-font-panel">閉じる</button>
      </div>
      <div class="panel-body">
        <input
          type="range"
          id="global-font-size"
          min="12"
          max="48"
          value="16"
        />
        <div class="panel-row">
          <input
            type="number"
            id="global-font-size-number"
            min="12"
            max="48"
            value="16"
            style="width: 72px"
          />
          px
        </div>
        <div class="panel-hint">ショートカット: Ctrl/⌘ + (+ / - / 0)</div>
      </div>
    </div>
    <!-- 検索置換パネル -->
    <div id="search-panel" class="floating-panel" style="display: none">
      <div class="panel-header">
        <span>検索と置換</span>
        <button class="panel-close" id="close-search-panel">閉じる</button>
      </div>
      <div class="panel-body">
        <input type="text" id="search-input" placeholder="検索するテキスト" />
        <input type="text" id="replace-input" placeholder="置換するテキスト" />
        <div class="panel-row">
          <label style="margin-right: 1rem"
            ><input type="checkbox" id="search-case-sensitive" />
            大文字/小文字を区別</label
          >
          <label><input type="checkbox" id="search-regex" /> 正規表現</label>
        </div>
        <div class="panel-row">
          <button id="replace-single" class="small" type="button">置換</button>
          <button id="replace-all" class="small" type="button">
            すべて置換
          </button>
          <button id="search-prev" class="small" type="button">前へ</button>
          <button id="search-next" class="small" type="button">次へ</button>
        </div>
        <div class="panel-hint">
          <span id="match-count">一致するテキストが見つかりません</span><br />
          <small>ショートカット: Ctrl+F で検索パネルを開く</small>
        </div>
      </div>
    </div>

    <!-- フォント装飾パネル -->
    <div id="font-decoration-panel" class="floating-panel" style="display: none">
      <div class="panel-header">
        <span>フォント装飾</span>
        <button class="panel-close" id="close-font-decoration-panel">閉じる</button>
      </div>
      <div class="panel-body">
        <div class="panel-row">
          <button id="decor-bold" class="decor-btn" data-tag="bold" title="太字 (Ctrl+B)">B</button>
          <button id="decor-italic" class="decor-btn" data-tag="italic" title="斜体 (Ctrl+I)">I</button>
          <button id="decor-underline" class="decor-btn" data-tag="underline" title="下線">U</button>
          <button id="decor-strike" class="decor-btn" data-tag="strike" title="取り消し線">S</button>
          <button id="decor-black" class="decor-btn" data-tag="black" title="極太">極</button>
        </div>
        <div class="panel-row">
          <button id="decor-light" class="decor-btn" data-tag="light" title="細字">細</button>
          <button id="decor-smallcaps" class="decor-btn" data-tag="smallcaps" title="スモールキャップ">SC</button>
          <button id="decor-shadow" class="decor-btn" data-tag="shadow" title="影付き">影</button>
          <button id="decor-outline" class="decor-btn" data-tag="outline" title="輪郭">輪</button>
          <button id="decor-glow" class="decor-btn" data-tag="glow" title="発光">光</button>
        </div>
        <div class="panel-row">
          <button id="decor-uppercase" class="decor-btn" data-tag="uppercase" title="大文字">大</button>
          <button id="decor-lowercase" class="decor-btn" data-tag="lowercase" title="小文字">小</button>
          <button id="decor-capitalize" class="decor-btn" data-tag="capitalize" title="先頭大文字">頭</button>
          <button id="decor-wide" class="decor-btn" data-tag="wide" title="文字間広">広</button>
          <button id="decor-narrow" class="decor-btn" data-tag="narrow" title="文字間狭">狭</button>
        </div>
        <div class="panel-hint">
          テキストを選択してボタンをクリック、またはタグを手動入力<br>
          例: [bold]テキスト[/bold]
        </div>
      </div>
    </div>

    <!-- テキストアニメーション パネル -->
    <div id="text-animation-panel" class="floating-panel" style="display: none">
      <div class="panel-header">
        <span>テキストアニメーション</span>
        <button class="panel-close" id="close-text-animation-panel">閉じる</button>
      </div>
      <div class="panel-body">
        <div class="panel-row">
          <button id="anim-fade" class="decor-btn" data-tag="fade" title="フェードイン">フェード</button>
          <button id="anim-slide" class="decor-btn" data-tag="slide" title="スライドイン">スライド</button>
          <button id="anim-type" class="decor-btn" data-tag="type" title="タイプライター">タイプ</button>
          <button id="anim-pulse" class="decor-btn" data-tag="pulse" title="パルス">パルス</button>
        </div>
        <div class="panel-row">
          <button id="anim-shake" class="decor-btn" data-tag="shake" title="シェイク">シェイク</button>
          <button id="anim-bounce" class="decor-btn" data-tag="bounce" title="バウンス">バウンス</button>
          <button id="anim-fadein" class="decor-btn" data-tag="fadein" title="ゆっくりフェード">遅フェード</button>
        </div>
        <div class="panel-hint">
          アニメーションタグでテキストに動きを付ける<br>
          例: [pulse]強調テキスト[/pulse]
        </div>
      </div>
    </div>

    <script src="js/gadgets.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/theme.js"></script>
    <script src="js/ui-labels.js"></script>
    <script src="js/element-manager.js"></script>
    <script src="js/sidebar-manager.js"></script>
    <script src="js/settings-manager.js"></script>
    <script src="js/search-manager.js"></script>
    <script src="js/hud.js"></script>
    <script src="js/editor.js"></script>
    <script src="js/app.js"></script>
    <!-- 埋め込み時のpostMessageブリッジ（?embed=1でREADY/RPC受信） -->
    <script src="js/embed/child-bridge.js"></script>
    <script>
      // 非埋め込み時のみ Outline/高度テーマ/プラグインを動的ロード（埋め込みでの初期ロードを軽量化）
      (function () {
        var isEmbed = /(?:^|[?&])embed=1(?:&|$)/.test(location.search);
        if (isEmbed) return;
        function load(src) {
          var s = document.createElement('script');
          s.src = src;
          s.defer = true;
          document.body.appendChild(s);
        }
        load('js/themes-advanced.js');
        load('js/plugins/registry.js');
        load('js/plugins/choice.js');
        load('js/gadgets.js');
        load('js/gadgets-editor-extras.js');
        load('js/images.js');
        load('js/wiki.js');
        load('js/nodegraph.js');
        load('js/panels.js');
      })();
    </script>
  </body>
</html>
